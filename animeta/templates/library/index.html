{% extends 'library/_base.html' %}

{% block library_content %}
<div id="app-root"></div>

{% raw %}
<script type="text/x-handlebars" data-template-name="components/item-status">
    {{#if isWatching}}
        {{#if hasProgress}}
            {{progressText}}
        {{else}}
            {{statusText}}
        {{/if}}
    {{else}}
        {{statusText}}
        {{#if hasProgress}}
            <span class="progress-muted">@ {{progressText}}</span>
        {{/if}}
    {{/if}}
</script>

<script type="text/x-handlebars" data-template-name="library">
<p>작품이 {{length}}개 등록되어 있습니다.</p>

{{outlet}}

<div class="library-item-list">
{{#each sectionedContents}}
    <div class="group">
        <h2>{{header}}</h2>
        <ul>
        {{#each items}}
            <li {{bind-attr class=":item status"}}>
                {{#link-to 'library.item' this}}
                    {{title}}
                    {{item-status status=status progress=progress}}
                {{/link-to}}
            </li>
        {{/each}}
        </ul>
    </div>
{{/each}}
</div>
</script>

<script type="text/x-handlebars" data-template-name="library/item">
<h1>{{title}} <button {{action 'close'}}>Close</button></h1>

{{#if canEdit}}
<div>
    <label>
        {{view App.RadioButton name='status'
                               selectionBinding='model.status'
                               value='watching'}}
        보는 중
    </label>
    <label>
        {{view App.RadioButton name='status'
                               selectionBinding='model.status'
                               value='finished'}}
        완료
    </label>
    <label>
        {{view App.RadioButton name='status'
                               selectionBinding='model.status'
                               value='suspended'}}
        중단
    </label>
</div>

<div>
    {{view Ember.TextField valueBinding='newUpdate.progress'}}{{newUpdate.progressSuffix}}<br>
    {{view Ember.TextArea valueBinding='newUpdate.comment'}}<br>
    <button {{action 'saveUpdate'}}>등록</button>
</div>
{{/if}}

<ul>
{{#each updates itemController='update'}}
    <li>
        {{progressText}} ({{status}}):
        {{comment}}
        {{updatedAtFromNow}}
        {{#if canEdit}}
            <button {{action 'delete'}}>x</button>
        {{/if}}
    </li>
{{/each}}
</ul>
</script>
{% endraw %}
{% endblock %}

{% block js %}
{{ super() }}
<script type="text/javascript" src="{{ url_for('static', filename='js/handlebars-1.0.0.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/ember-1.0.0.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/library.js') }}"></script>
<script>
App.CURRENT_USER_ID = {{ (current_user.id or None)|tojson }};
App.DATA_ITEMS = {{ items|serialize }}.map(function(data) {
    data.updatedAt = new Date(data.updatedAt * 1000);
    return App.LibraryItem.create(data);
});
</script>
{% endblock %}
